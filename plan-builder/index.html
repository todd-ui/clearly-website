<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYZ1XEXPMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DYZ1XEXPMT');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Build Your Custody Plan | Clearly</title>
  <meta name="description" content="Create a clear, professional custody schedule in minutes. Free custody plan builder with calendar preview and printable documents.">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://getclearly.app/plan-builder/">

  <!-- Indexing - HIDDEN FOR NOW -->
  <meta name="robots" content="noindex, nofollow">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://getclearly.app/plan-builder/">
  <meta property="og:title" content="Build Your Custody Plan | Clearly">
  <meta property="og:description" content="Create a clear, professional custody schedule in minutes. Free custody plan builder with calendar preview and printable documents.">
  <meta property="og:image" content="https://dwncravjhkbclbuzijra.supabase.co/storage/v1/object/public/Clearly%20Logos/icon.png">
  <meta property="og:site_name" content="Clearly">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Build Your Custody Plan | Clearly">
  <meta name="twitter:description" content="Create a clear, professional custody schedule in minutes. Free custody plan builder with calendar preview and printable documents.">
  <meta name="twitter:image" content="https://dwncravjhkbclbuzijra.supabase.co/storage/v1/object/public/Clearly%20Logos/icon.png">

  <link rel="icon" href="https://dwncravjhkbclbuzijra.supabase.co/storage/v1/object/public/Clearly%20Logos/favicon.png">
  <link rel="apple-touch-icon" href="https://dwncravjhkbclbuzijra.supabase.co/storage/v1/object/public/Clearly%20Logos/icon.png">

  <style>
    :root {
      --primary: #0D8268;
      --primary-dark: #0a6b56;
      --primary-soft: #E6F5F1;
      --primary-border: #A8DFD0;
      --bg: #FAFAF9;
      --surface: #FFFFFF;
      --text: #1A1917;
      --text-secondary: #5C5856;
      --text-muted: #8C8780;
      --border: #E8E7E4;
      --coparent: #E8E7E4;
      --error: #DC3545;
      --gradient: linear-gradient(135deg, #0D8268 0%, #14a085 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* App Container */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Progress Bar */
    .progress-bar {
      height: 4px;
      background: var(--border);
      flex-shrink: 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .back-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--bg);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: var(--border);
    }

    .back-btn svg {
      width: 20px;
      height: 20px;
      stroke: var(--text);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }

    .logo img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .step-counter {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Main Content */
    .main {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .screen {
      display: none;
      flex: 1;
      padding: 48px 24px;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .screen-content {
      max-width: 640px;
      margin: 0 auto;
      width: 100%;
    }

    .screen h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
      color: var(--text);
    }

    .screen p.subtitle {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 40px;
      line-height: 1.6;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card:hover {
      border-color: var(--primary-border);
    }

    .card.selected {
      border-color: var(--primary);
      background: var(--primary-soft);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 500px) {
      .card-grid {
        grid-template-columns: 1fr;
      }
    }

    .card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .card p {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .card-icon {
      width: 48px;
      height: 48px;
      background: var(--primary-soft);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: var(--primary);
      font-size: 24px;
    }

    .card.selected .card-icon {
      background: var(--primary);
      color: white;
    }

    /* Chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chip {
      padding: 12px 20px;
      border: 2px solid var(--border);
      border-radius: 100px;
      background: var(--surface);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .chip:hover {
      border-color: var(--primary-border);
    }

    .chip.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s;
      background: var(--surface);
      color: var(--text);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    select.form-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235C5856' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 48px;
    }

    /* Child Cards */
    .child-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .child-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .child-number {
      width: 32px;
      height: 32px;
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .remove-child {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .remove-child:hover {
      color: var(--error);
    }

    /* Schedule Cards */
    .schedule-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .schedule-card:hover {
      border-color: var(--primary-border);
    }

    .schedule-card.selected {
      border-color: var(--primary);
      background: var(--primary-soft);
    }

    .schedule-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .schedule-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .schedule-split {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
      background: var(--primary-soft);
      padding: 4px 12px;
      border-radius: 100px;
    }

    .schedule-card.selected .schedule-split {
      background: var(--primary);
      color: white;
    }

    .schedule-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    /* Mini Calendar Preview */
    .mini-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .mini-calendar-day {
      aspect-ratio: 1;
      border-radius: 4px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mini-calendar-day.you {
      background: var(--primary);
      color: white;
    }

    .mini-calendar-day.coparent {
      background: var(--coparent);
      color: var(--text-secondary);
    }

    .mini-calendar-label {
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
    }

    /* Full Calendar */
    .calendar-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 32px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-nav button:hover {
      background: var(--bg);
    }

    .calendar-month {
      font-size: 18px;
      font-weight: 600;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      position: relative;
      min-height: 44px;
    }

    .calendar-day.empty {
      background: transparent;
    }

    .calendar-day.you {
      background: var(--primary);
      color: white;
    }

    .calendar-day.coparent {
      background: var(--coparent);
      color: var(--text-secondary);
    }

    .calendar-day.today {
      box-shadow: inset 0 0 0 2px var(--text);
    }

    .calendar-day .exchange-dot {
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.5;
    }

    .calendar-day .holiday-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #F5A623;
    }

    .calendar-legend {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .legend-dot.you {
      background: var(--primary);
    }

    .legend-dot.coparent {
      background: var(--coparent);
    }

    /* Holiday List */
    .holiday-section {
      margin-bottom: 32px;
    }

    .holiday-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .holiday-section-title svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
    }

    .holiday-section.collapsed .holiday-section-title svg {
      transform: rotate(-90deg);
    }

    .holiday-section.collapsed .holiday-items {
      display: none;
    }

    .holiday-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .holiday-item:last-child {
      border-bottom: none;
    }

    .holiday-name {
      font-size: 15px;
      color: var(--text);
    }

    .holiday-chips {
      display: flex;
      gap: 6px;
    }

    .holiday-chip {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface);
      color: var(--text-secondary);
    }

    .holiday-chip:hover {
      border-color: var(--primary-border);
    }

    .holiday-chip.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    /* Toggle Switch */
    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
    }

    .toggle-label {
      font-size: 16px;
      color: var(--text);
    }

    .toggle {
      width: 52px;
      height: 32px;
      background: var(--border);
      border-radius: 16px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle.active {
      background: var(--primary);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toggle.active::after {
      transform: translateX(20px);
    }

    /* Expense Split */
    .expense-split {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .expense-split-bar {
      flex: 1;
      height: 12px;
      background: var(--coparent);
      border-radius: 6px;
      position: relative;
      overflow: hidden;
    }

    .expense-split-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s;
    }

    .expense-split-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .expense-split-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Review Section */
    .review-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .review-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .review-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .edit-link {
      font-size: 14px;
      color: var(--primary);
      cursor: pointer;
    }

    .edit-link:hover {
      text-decoration: underline;
    }

    .review-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 15px;
    }

    .review-item-label {
      color: var(--text-secondary);
    }

    .review-item-value {
      color: var(--text);
      font-weight: 500;
    }

    /* Plan Code */
    .plan-code-display {
      background: var(--primary-soft);
      border: 2px solid var(--primary);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      margin: 32px 0;
    }

    .plan-code-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .plan-code-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      font-family: monospace;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }

    .copy-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: var(--primary-dark);
    }

    /* Next Steps */
    .next-steps {
      margin-top: 32px;
    }

    .next-step {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .step-content h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .step-content p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Footer Actions */
    .footer {
      padding: 16px 24px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .footer-content {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-primary:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
    }

    /* Print Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      justify-content: flex-end;
    }

    /* Print Styles */
    .print-content {
      font-size: 14px;
      line-height: 1.8;
    }

    .print-content h1 {
      font-size: 24px;
      margin-bottom: 24px;
      text-align: center;
    }

    .print-content h2 {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 12px;
      color: var(--primary);
    }

    .print-content p {
      margin-bottom: 12px;
      color: var(--text-secondary);
    }

    .print-footer {
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }

    /* AI Upload */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover {
      border-color: var(--primary-border);
      background: var(--primary-soft);
    }

    .upload-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-soft);
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      background: var(--primary-soft);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: var(--primary);
      font-size: 28px;
    }

    .upload-zone h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-zone p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .privacy-notice {
      background: var(--primary-soft);
      border: 1px solid var(--primary-border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 24px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .privacy-notice strong {
      color: var(--primary);
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 48px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .screen {
        padding: 32px 16px;
      }

      .screen h1 {
        font-size: 26px;
      }

      .screen p.subtitle {
        font-size: 15px;
        margin-bottom: 32px;
      }

      .calendar-day {
        font-size: 12px;
        min-height: 36px;
      }

      .footer {
        padding: 12px 16px;
      }

      .btn {
        padding: 12px 24px;
        font-size: 15px;
      }
    }

    @media print {
      .app { display: none; }
      .print-only { display: block !important; }
    }

    .print-only {
      display: none;
    }

    /* Category checkboxes */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 500px) {
      .category-grid {
        grid-template-columns: 1fr;
      }
    }

    .category-checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-checkbox:hover {
      border-color: var(--primary-border);
    }

    .category-checkbox.selected {
      border-color: var(--primary);
      background: var(--primary-soft);
    }

    .category-checkbox input {
      display: none;
    }

    .category-checkbox .checkbox-icon {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .category-checkbox.selected .checkbox-icon {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .category-checkbox .category-label {
      font-size: 15px;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="back-btn" id="backBtn" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <a href="/" class="logo">
          <img src="https://dwncravjhkbclbuzijra.supabase.co/storage/v1/object/public/Clearly%20Logos/icon.png" alt="Clearly">
          Clearly
        </a>
      </div>
      <div class="step-counter" id="stepCounter">Step 1 of 11</div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <!-- Screen 1: Welcome -->
      <div class="screen active" id="screen-welcome">
        <div class="screen-content">
          <h1>Build Your Custody Plan</h1>
          <p class="subtitle">Create a clear, professional custody schedule in minutes â€” free.</p>

          <div class="card-grid">
            <div class="card" data-pathway="exploration">
              <div class="card-icon">&#128269;</div>
              <h3>I'm exploring options</h3>
              <p>Get personalized schedule suggestions based on your family</p>
            </div>
            <div class="card" data-pathway="agreement">
              <div class="card-icon">&#128196;</div>
              <h3>I have an agreement</h3>
              <p>Enter your existing custody terms or upload your agreement</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Screen 2: Children -->
      <div class="screen" id="screen-children">
        <div class="screen-content">
          <h1>Tell us about your children</h1>
          <p class="subtitle">This helps us personalize your schedule options.</p>

          <div class="form-group">
            <label class="form-label">How many children?</label>
            <div class="chips" id="childCountChips">
              <div class="chip" data-count="1">1</div>
              <div class="chip" data-count="2">2</div>
              <div class="chip" data-count="3">3</div>
              <div class="chip" data-count="4">4</div>
              <div class="chip" data-count="5">5+</div>
            </div>
          </div>

          <div id="childrenContainer"></div>

          <button class="btn btn-secondary" id="addChildBtn" style="display: none; margin-top: 16px;">
            + Add Another Child
          </button>
        </div>
      </div>

      <!-- Screen 3: Schedule Selection -->
      <div class="screen" id="screen-schedule">
        <div class="screen-content">
          <h1 id="scheduleTitle">Select your schedule</h1>
          <p class="subtitle" id="scheduleSubtitle">Choose a custody schedule pattern.</p>

          <div id="scheduleGrid" style="display: grid; gap: 16px;"></div>
        </div>
      </div>

      <!-- Screen 4: Configure Schedule -->
      <div class="screen" id="screen-configure">
        <div class="screen-content">
          <h1>Configure your schedule</h1>
          <p class="subtitle">Set up the specifics of your custody arrangement.</p>

          <div id="configureOptions"></div>

          <div class="calendar-container" id="calendarPreview">
            <div class="calendar-header">
              <button class="calendar-nav-btn" id="prevMonth">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <span class="calendar-month" id="calendarMonth"></span>
              <button class="calendar-nav-btn" id="nextMonth">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </div>
            <div class="calendar-weekdays">
              <div class="calendar-weekday">Sun</div>
              <div class="calendar-weekday">Mon</div>
              <div class="calendar-weekday">Tue</div>
              <div class="calendar-weekday">Wed</div>
              <div class="calendar-weekday">Thu</div>
              <div class="calendar-weekday">Fri</div>
              <div class="calendar-weekday">Sat</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="calendar-legend">
              <div class="legend-item">
                <div class="legend-dot you"></div>
                <span>You</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot coparent"></div>
                <span>Co-parent</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Screen 5: Holidays -->
      <div class="screen" id="screen-holidays">
        <div class="screen-content">
          <h1>Holiday schedule</h1>
          <p class="subtitle">How do you want to handle holidays?</p>

          <div class="form-group">
            <label class="form-label">Quick preset</label>
            <div class="chips" id="holidayPresetChips">
              <div class="chip selected" data-preset="alternate">Alternate all</div>
              <div class="chip" data-preset="split">Split evenly</div>
              <div class="chip" data-preset="custom">Custom</div>
            </div>
          </div>

          <div id="holidayList"></div>
        </div>
      </div>

      <!-- Screen 6: Summer -->
      <div class="screen" id="screen-summer">
        <div class="screen-content">
          <h1>Summer schedule</h1>
          <p class="subtitle">Do you have a different schedule during summer?</p>

          <div class="toggle-group">
            <span class="toggle-label">Enable summer schedule</span>
            <div class="toggle" id="summerToggle"></div>
          </div>

          <div id="summerOptions" style="display: none;"></div>
        </div>
      </div>

      <!-- Screen 7: Expenses -->
      <div class="screen" id="screen-expenses">
        <div class="screen-content">
          <h1>Expenses & reimbursement</h1>
          <p class="subtitle">Define how you'll split child-related expenses.</p>

          <div class="form-group">
            <label class="form-label">How are shared expenses split?</label>
            <div class="chips" id="expenseSplitChips">
              <div class="chip selected" data-split="50">50/50</div>
              <div class="chip" data-split="60">60/40</div>
              <div class="chip" data-split="70">70/30</div>
              <div class="chip" data-split="custom">Custom</div>
            </div>
          </div>

          <div id="customSplitInputs" style="display: none;"></div>

          <div class="expense-split">
            <div style="flex: 1;">
              <div class="expense-split-bar">
                <div class="expense-split-fill" id="expenseFill" style="width: 50%;"></div>
              </div>
              <div class="expense-split-labels">
                <span class="expense-split-label">You: <strong id="expenseYou">50%</strong></span>
                <span class="expense-split-label">Co-parent: <strong id="expenseCoparent">50%</strong></span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Categories to track</label>
            <div class="category-grid" id="categoryGrid"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Preferred reimbursement method (optional)</label>
            <select class="form-input" id="reimbursementMethod">
              <option value="">Select method...</option>
              <option value="venmo">Venmo</option>
              <option value="paypal">PayPal</option>
              <option value="zelle">Zelle</option>
              <option value="bank">Bank Transfer</option>
              <option value="cash">Cash</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group" id="reimbursementHandleGroup" style="display: none;">
            <label class="form-label" id="reimbursementHandleLabel">Username/Handle</label>
            <input type="text" class="form-input" id="reimbursementHandle" placeholder="@username">
          </div>
        </div>
      </div>

      <!-- Screen 8: AI Upload (Agreement mode only) -->
      <div class="screen" id="screen-upload">
        <div class="screen-content">
          <h1>Upload your agreement</h1>
          <p class="subtitle">We'll extract your custody terms automatically.</p>

          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">&#128196;</div>
            <h3>Drop your agreement PDF here</h3>
            <p>or click to browse (PDF, max 10MB)</p>
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
          </div>

          <div class="privacy-notice">
            <strong>Your privacy is protected.</strong> Your agreement is processed securely and never stored. The document is analyzed in memory, extracted data is shown to you for review, then the file is immediately deleted. We don't keep copies.
          </div>

          <div class="loading-state" id="uploadLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="uploadStatus">Reading your agreement...</p>
          </div>

          <div style="text-align: center; margin-top: 24px;">
            <button class="btn btn-secondary" id="skipUpload">Enter manually instead</button>
          </div>
        </div>
      </div>

      <!-- Screen 9: Review -->
      <div class="screen" id="screen-review">
        <div class="screen-content">
          <h1>Review your plan</h1>
          <p class="subtitle">Here's a summary of your custody arrangement.</p>

          <div id="reviewSections"></div>

          <div class="calendar-container" id="reviewCalendar">
            <div class="calendar-header">
              <button class="calendar-nav-btn" id="reviewPrevMonth">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <span class="calendar-month" id="reviewCalendarMonth"></span>
              <button class="calendar-nav-btn" id="reviewNextMonth">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </div>
            <div class="calendar-weekdays">
              <div class="calendar-weekday">Sun</div>
              <div class="calendar-weekday">Mon</div>
              <div class="calendar-weekday">Tue</div>
              <div class="calendar-weekday">Wed</div>
              <div class="calendar-weekday">Thu</div>
              <div class="calendar-weekday">Fri</div>
              <div class="calendar-weekday">Sat</div>
            </div>
            <div class="calendar-days" id="reviewCalendarDays"></div>
            <div class="calendar-legend">
              <div class="legend-item">
                <div class="legend-dot you"></div>
                <span>You</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot coparent"></div>
                <span>Co-parent</span>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-secondary" id="printPlanBtn" style="flex: 1;">Print Plan</button>
          </div>
        </div>
      </div>

      <!-- Screen 10: Email Capture -->
      <div class="screen" id="screen-email">
        <div class="screen-content">
          <h1>Save your plan</h1>
          <p class="subtitle">Enter your email and we'll send you your Plan Code plus a copy of your plan.</p>

          <div class="form-group">
            <label class="form-label">Email address</label>
            <input type="email" class="form-input" id="emailInput" placeholder="you@example.com" required>
          </div>

          <div class="form-group">
            <label class="form-label">First name (optional)</label>
            <input type="text" class="form-input" id="firstNameInput" placeholder="Your first name">
          </div>
        </div>
      </div>

      <!-- Screen 11: Plan Code -->
      <div class="screen" id="screen-complete">
        <div class="screen-content">
          <h1>You're all set!</h1>
          <p class="subtitle">We've emailed your plan and code. Use it to set up your schedule in the Clearly app.</p>

          <div class="plan-code-display">
            <div class="plan-code-label">Your Plan Code</div>
            <div class="plan-code-value" id="planCodeValue">ABC12345</div>
            <button class="copy-btn" id="copyCodeBtn">Copy Code</button>
          </div>

          <div class="next-steps">
            <div class="next-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <h4>Download Clearly</h4>
                <p>Get the app from the App Store</p>
              </div>
            </div>
            <div class="next-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4>Create your account</h4>
                <p>Sign up with your email</p>
              </div>
            </div>
            <div class="next-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4>Enter your Plan Code</h4>
                <p>During setup, enter your code to auto-configure</p>
              </div>
            </div>
            <div class="next-step">
              <div class="step-number">4</div>
              <div class="step-content">
                <h4>Share with co-parent</h4>
                <p>Send your code so you both have the same schedule</p>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 32px;">
            <a href="https://apps.apple.com/app/clearly-co-parenting" target="_blank" class="btn btn-primary">Download Clearly</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer" id="footer">
      <div class="footer-content">
        <button class="btn btn-primary" id="nextBtn" disabled>Continue</button>
      </div>
    </div>
  </div>

  <!-- Print Modal -->
  <div class="modal-overlay" id="printModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Your Custody Plan</h2>
        <button class="modal-close" id="closePrintModal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="print-content" id="printContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="downloadPdfBtn">Download PDF</button>
        <button class="btn btn-primary" id="printNowBtn">Print</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CUSTODY PATTERNS - Ported from app
    // ============================================
    const CUSTODY_PATTERNS = {
      'week-on-week-off': {
        id: 'week-on-week-off',
        name: 'Alternating Weeks',
        description: 'One parent has 7 days, then the other has 7 days',
        split: '50/50',
        pattern: [1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
        cycleLength: 14,
      },
      '2-2-3': {
        id: '2-2-3',
        name: '2-2-3',
        description: 'Exchanges on Mon/Wed/Fri. Frequent transitions.',
        split: '50/50',
        pattern: [1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0],
        cycleLength: 14,
        fixedExchangeDays: true,
      },
      '5-2-2-5': {
        id: '5-2-2-5',
        name: '5-2-2-5',
        description: 'Five days with one parent, then a switch mid-week.',
        split: '50/50',
        pattern: [1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
        cycleLength: 14,
        fixedExchangeDays: true,
      },
      '3-4-4-3': {
        id: '3-4-4-3',
        name: '3-4-4-3',
        description: 'Three/four day alternating blocks.',
        split: '50/50',
        pattern: [1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1],
        cycleLength: 14,
        fixedExchangeDays: true,
      },
      '4-3': {
        id: '4-3',
        name: '4-3',
        description: '4 days with one parent, 3 with the other each week.',
        split: '57/43',
        pattern: [1, 1, 1, 1, 0, 0, 0],
        cycleLength: 7,
      },
      'primary-every-other-weekend': {
        id: 'primary-every-other-weekend',
        name: 'Primary + Every Other Weekend',
        description: 'Primary parent weekdays, other parent every other weekend.',
        split: '79/21',
        pattern: [1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],
        cycleLength: 14,
      },
      'every-other-weekend-only': {
        id: 'every-other-weekend-only',
        name: 'Every Other Weekend Only',
        description: 'You have kids only on alternating weekends.',
        split: '21/79',
        pattern: [0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0],
        cycleLength: 14,
      },
      'custom': {
        id: 'custom',
        name: 'Custom Schedule',
        description: 'Build your own pattern.',
        split: 'Custom',
        pattern: [],
        cycleLength: 14,
      },
    };

    const HOLIDAYS = {
      major: [
        { id: 'thanksgiving', name: 'Thanksgiving' },
        { id: 'christmas_eve', name: 'Christmas Eve' },
        { id: 'christmas_day', name: 'Christmas Day' },
        { id: 'new_years_eve', name: "New Year's Eve" },
        { id: 'new_years_day', name: "New Year's Day" },
      ],
      spring_summer: [
        { id: 'easter', name: 'Easter' },
        { id: 'memorial_day', name: 'Memorial Day' },
        { id: 'july_4th', name: 'July 4th' },
        { id: 'labor_day', name: 'Labor Day' },
      ],
      other: [
        { id: 'halloween', name: 'Halloween' },
        { id: 'mothers_day', name: "Mother's Day" },
        { id: 'fathers_day', name: "Father's Day" },
        { id: 'spring_break', name: 'Spring Break' },
      ],
    };

    const EXPENSE_CATEGORIES = [
      { id: 'medical', name: 'Medical' },
      { id: 'education', name: 'Education' },
      { id: 'activities', name: 'Sports/Activities' },
      { id: 'clothing', name: 'Clothing' },
      { id: 'childcare', name: 'Childcare' },
      { id: 'other', name: 'Other' },
    ];

    // Age-based schedule recommendations
    const AGE_RECOMMENDATIONS = {
      'under-2': ['2-2-3'],
      '2-5': ['2-2-3', '5-2-2-5'],
      '6-12': ['week-on-week-off', '5-2-2-5', '2-2-3', '3-4-4-3'],
      '13-17': ['week-on-week-off', '5-2-2-5'],
      '18+': [],
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const state = {
      currentScreen: 0,
      pathway: null, // 'exploration' or 'agreement'
      children: [],
      schedule: {
        type: null,
        anchorDate: new Date().toISOString().split('T')[0],
        anchorParent: 'you',
        week1Parent: 'you',
        week1IsoParity: 'odd',
        exchangeTime: '18:00',
        customPattern: null,
      },
      holidays: {},
      holidayPreset: 'alternate',
      summer: {
        enabled: false,
        startMonth: 6,
        startWeek: 2,
        startWeekday: 5, // Friday
        endMonth: 8,
        endWeek: 3,
        endWeekday: 5,
        pattern: 'alternating-weeks',
        startsWithYou: true,
      },
      expenses: {
        splitYou: 50,
        splitCoparent: 50,
        categories: ['medical', 'education', 'activities'],
        reimbursementMethod: null,
        reimbursementHandle: null,
      },
      email: null,
      firstName: null,
      planCode: null,
    };

    const screens = [
      'screen-welcome',
      'screen-children',
      'screen-schedule',
      'screen-configure',
      'screen-holidays',
      'screen-summer',
      'screen-expenses',
      'screen-review',
      'screen-email',
      'screen-complete',
    ];

    // Insert upload screen for agreement pathway
    const screensWithUpload = [
      'screen-welcome',
      'screen-upload',
      'screen-children',
      'screen-schedule',
      'screen-configure',
      'screen-holidays',
      'screen-summer',
      'screen-expenses',
      'screen-review',
      'screen-email',
      'screen-complete',
    ];

    let activeScreens = screens;
    let calendarMonth = new Date();
    let reviewCalendarMonth = new Date();

    // ============================================
    // DOM ELEMENTS
    // ============================================
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // ============================================
    // INITIALIZATION
    // ============================================
    function init() {
      setupEventListeners();
      renderScreen();
      updateProgress();
    }

    function setupEventListeners() {
      // Navigation
      $('#backBtn').addEventListener('click', goBack);
      $('#nextBtn').addEventListener('click', goNext);

      // Welcome screen cards
      $$('#screen-welcome .card').forEach(card => {
        card.addEventListener('click', () => {
          $$('#screen-welcome .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          state.pathway = card.dataset.pathway;

          // Update screens based on pathway
          activeScreens = state.pathway === 'agreement' ? screensWithUpload : screens;

          validateCurrentScreen();
        });
      });

      // Child count chips
      $$('#childCountChips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#childCountChips .chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          const count = parseInt(chip.dataset.count) || 5;
          setChildCount(count);
          validateCurrentScreen();
        });
      });

      // Add child button
      $('#addChildBtn').addEventListener('click', () => {
        if (state.children.length < 6) {
          state.children.push({ name: '', ageGroup: null });
          renderChildren();
        }
      });

      // Holiday preset chips
      $$('#holidayPresetChips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#holidayPresetChips .chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          state.holidayPreset = chip.dataset.preset;
          applyHolidayPreset();
          renderHolidays();
        });
      });

      // Summer toggle
      $('#summerToggle').addEventListener('click', () => {
        state.summer.enabled = !state.summer.enabled;
        $('#summerToggle').classList.toggle('active', state.summer.enabled);
        renderSummerOptions();
      });

      // Expense split chips
      $$('#expenseSplitChips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#expenseSplitChips .chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          const split = chip.dataset.split;
          if (split === 'custom') {
            showCustomSplitInputs();
          } else {
            hideCustomSplitInputs();
            const you = parseInt(split);
            state.expenses.splitYou = you;
            state.expenses.splitCoparent = 100 - you;
            updateExpenseSplitDisplay();
          }
        });
      });

      // Reimbursement method
      $('#reimbursementMethod').addEventListener('change', (e) => {
        state.expenses.reimbursementMethod = e.target.value;
        if (e.target.value && e.target.value !== 'cash' && e.target.value !== 'bank') {
          $('#reimbursementHandleGroup').style.display = 'block';
          const labels = { venmo: '@username', paypal: 'Email or @username', zelle: 'Phone or email' };
          $('#reimbursementHandle').placeholder = labels[e.target.value] || 'Username';
        } else {
          $('#reimbursementHandleGroup').style.display = 'none';
        }
      });

      $('#reimbursementHandle').addEventListener('input', (e) => {
        state.expenses.reimbursementHandle = e.target.value;
      });

      // Calendar navigation
      $('#prevMonth').addEventListener('click', () => {
        calendarMonth.setMonth(calendarMonth.getMonth() - 1);
        renderCalendar();
      });
      $('#nextMonth').addEventListener('click', () => {
        calendarMonth.setMonth(calendarMonth.getMonth() + 1);
        renderCalendar();
      });

      // Review calendar navigation
      $('#reviewPrevMonth').addEventListener('click', () => {
        reviewCalendarMonth.setMonth(reviewCalendarMonth.getMonth() - 1);
        renderReviewCalendar();
      });
      $('#reviewNextMonth').addEventListener('click', () => {
        reviewCalendarMonth.setMonth(reviewCalendarMonth.getMonth() + 1);
        renderReviewCalendar();
      });

      // Print
      $('#printPlanBtn').addEventListener('click', showPrintModal);
      $('#closePrintModal').addEventListener('click', () => $('#printModal').classList.remove('active'));
      $('#printNowBtn').addEventListener('click', () => window.print());
      $('#downloadPdfBtn').addEventListener('click', downloadPdf);

      // Email inputs
      $('#emailInput').addEventListener('input', (e) => {
        state.email = e.target.value;
        validateCurrentScreen();
      });
      $('#firstNameInput').addEventListener('input', (e) => {
        state.firstName = e.target.value;
      });

      // Copy code
      $('#copyCodeBtn').addEventListener('click', copyPlanCode);

      // Upload
      $('#uploadZone').addEventListener('click', () => $('#fileInput').click());
      $('#fileInput').addEventListener('change', handleFileUpload);
      $('#skipUpload').addEventListener('click', () => {
        goToScreen(activeScreens.indexOf('screen-children'));
      });

      // Drag and drop
      const uploadZone = $('#uploadZone');
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });
      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0]);
        }
      });
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function goToScreen(index) {
      state.currentScreen = index;
      renderScreen();
      updateProgress();
    }

    function goBack() {
      if (state.currentScreen > 0) {
        state.currentScreen--;
        renderScreen();
        updateProgress();
      }
    }

    function goNext() {
      if (state.currentScreen < activeScreens.length - 1) {
        state.currentScreen++;
        renderScreen();
        updateProgress();
      }
    }

    function updateProgress() {
      const progress = ((state.currentScreen + 1) / activeScreens.length) * 100;
      $('#progress').style.width = `${progress}%`;
      $('#stepCounter').textContent = `Step ${state.currentScreen + 1} of ${activeScreens.length}`;
      $('#backBtn').style.display = state.currentScreen > 0 ? 'flex' : 'none';
    }

    function renderScreen() {
      // Hide all screens
      $$('.screen').forEach(s => s.classList.remove('active'));

      // Show current screen
      const screenId = activeScreens[state.currentScreen];
      $(`#${screenId}`).classList.add('active');

      // Update footer
      const isLastScreen = screenId === 'screen-complete';
      $('#footer').style.display = isLastScreen ? 'none' : 'block';
      $('#nextBtn').textContent = screenId === 'screen-email' ? 'Get My Plan Code' : 'Continue';

      // Screen-specific setup
      switch (screenId) {
        case 'screen-children':
          if (state.children.length === 0) {
            state.children = [{ name: '', ageGroup: null }];
          }
          renderChildren();
          break;
        case 'screen-schedule':
          renderScheduleOptions();
          break;
        case 'screen-configure':
          renderConfigureOptions();
          renderCalendar();
          break;
        case 'screen-holidays':
          applyHolidayPreset();
          renderHolidays();
          break;
        case 'screen-summer':
          renderSummerOptions();
          break;
        case 'screen-expenses':
          renderExpenseCategories();
          updateExpenseSplitDisplay();
          break;
        case 'screen-review':
          renderReview();
          renderReviewCalendar();
          break;
        case 'screen-email':
          break;
        case 'screen-complete':
          submitPlan();
          break;
      }

      validateCurrentScreen();
    }

    function validateCurrentScreen() {
      const screenId = activeScreens[state.currentScreen];
      let valid = false;

      switch (screenId) {
        case 'screen-welcome':
          valid = state.pathway !== null;
          break;
        case 'screen-children':
          valid = state.children.length > 0 && state.children.every(c => c.ageGroup);
          break;
        case 'screen-schedule':
          valid = state.schedule.type !== null;
          break;
        case 'screen-configure':
          valid = true; // Always valid once schedule is selected
          break;
        case 'screen-holidays':
          valid = true;
          break;
        case 'screen-summer':
          valid = true;
          break;
        case 'screen-expenses':
          valid = state.expenses.categories.length > 0;
          break;
        case 'screen-review':
          valid = true;
          break;
        case 'screen-email':
          valid = state.email && state.email.includes('@');
          break;
        case 'screen-upload':
          valid = true; // Can always skip
          break;
        default:
          valid = true;
      }

      $('#nextBtn').disabled = !valid;
    }

    // ============================================
    // CHILDREN
    // ============================================
    function setChildCount(count) {
      while (state.children.length < count) {
        state.children.push({ name: '', ageGroup: null });
      }
      while (state.children.length > count) {
        state.children.pop();
      }
      renderChildren();
    }

    function renderChildren() {
      const container = $('#childrenContainer');
      container.innerHTML = state.children.map((child, i) => `
        <div class="child-card">
          <div class="child-card-header">
            <div class="child-number">${i + 1}</div>
            ${state.children.length > 1 ? `
              <button class="remove-child" data-index="${i}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            ` : ''}
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">Name (optional)</label>
            <input type="text" class="form-input child-name" data-index="${i}" value="${child.name}" placeholder="Child's name">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Age</label>
            <div class="chips child-age-chips" data-index="${i}">
              <div class="chip ${child.ageGroup === 'under-2' ? 'selected' : ''}" data-age="under-2">Under 2</div>
              <div class="chip ${child.ageGroup === '2-5' ? 'selected' : ''}" data-age="2-5">2-5</div>
              <div class="chip ${child.ageGroup === '6-12' ? 'selected' : ''}" data-age="6-12">6-12</div>
              <div class="chip ${child.ageGroup === '13-17' ? 'selected' : ''}" data-age="13-17">13-17</div>
            </div>
          </div>
        </div>
      `).join('');

      // Event listeners for child inputs
      $$('.child-name').forEach(input => {
        input.addEventListener('input', (e) => {
          state.children[e.target.dataset.index].name = e.target.value;
        });
      });

      $$('.child-age-chips').forEach(chips => {
        chips.querySelectorAll('.chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const index = chips.dataset.index;
            chips.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.children[index].ageGroup = chip.dataset.age;
            validateCurrentScreen();
          });
        });
      });

      $$('.remove-child').forEach(btn => {
        btn.addEventListener('click', () => {
          state.children.splice(btn.dataset.index, 1);
          // Update child count chip selection
          const count = state.children.length;
          $$('#childCountChips .chip').forEach(c => {
            c.classList.toggle('selected', c.dataset.count == count || (count >= 5 && c.dataset.count == '5'));
          });
          renderChildren();
          validateCurrentScreen();
        });
      });

      $('#addChildBtn').style.display = state.children.length < 6 ? 'inline-block' : 'none';
    }

    // ============================================
    // SCHEDULE
    // ============================================
    function getRecommendedSchedules() {
      if (state.children.length === 0) return Object.keys(CUSTODY_PATTERNS);

      // Find the youngest child's age group
      const ageOrder = ['under-2', '2-5', '6-12', '13-17', '18+'];
      let youngestIndex = 999;
      state.children.forEach(child => {
        const index = ageOrder.indexOf(child.ageGroup);
        if (index < youngestIndex && index !== -1) {
          youngestIndex = index;
        }
      });

      const youngestAge = ageOrder[youngestIndex] || '6-12';
      return AGE_RECOMMENDATIONS[youngestAge] || Object.keys(CUSTODY_PATTERNS).filter(k => k !== 'custom');
    }

    function renderScheduleOptions() {
      const container = $('#scheduleGrid');
      const recommended = getRecommendedSchedules();
      const isExploration = state.pathway === 'exploration';

      if (isExploration) {
        $('#scheduleTitle').textContent = 'Recommended schedules';
        $('#scheduleSubtitle').textContent = 'Based on your family, here are our suggestions.';
      } else {
        $('#scheduleTitle').textContent = 'Select your schedule';
        $('#scheduleSubtitle').textContent = 'Choose the custody pattern from your agreement.';
      }

      // Show recommended first, then others
      const patterns = isExploration
        ? [...recommended, ...Object.keys(CUSTODY_PATTERNS).filter(k => !recommended.includes(k) && k !== 'custom'), 'custom']
        : Object.keys(CUSTODY_PATTERNS);

      container.innerHTML = patterns.map((patternId, i) => {
        const pattern = CUSTODY_PATTERNS[patternId];
        const isRecommended = recommended.includes(patternId) && isExploration;
        const isSelected = state.schedule.type === patternId;

        return `
          <div class="schedule-card ${isSelected ? 'selected' : ''}" data-pattern="${patternId}">
            <div class="schedule-card-header">
              <span class="schedule-name">${pattern.name}</span>
              <span class="schedule-split">${pattern.split}</span>
            </div>
            <p class="schedule-desc">${pattern.description}${isRecommended ? ' <strong style="color: var(--primary);">Recommended</strong>' : ''}</p>
            ${patternId !== 'custom' ? `
              <div class="mini-calendar">
                ${renderMiniCalendar(pattern.pattern, 14)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      $$('.schedule-card').forEach(card => {
        card.addEventListener('click', () => {
          $$('.schedule-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          state.schedule.type = card.dataset.pattern;
          validateCurrentScreen();
        });
      });
    }

    function renderMiniCalendar(pattern, days) {
      if (!pattern || pattern.length === 0) return '';

      let html = '';
      const labels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

      // Week labels
      html += labels.map(l => `<div class="mini-calendar-label">${l}</div>`).join('');

      // Days
      for (let i = 0; i < Math.min(days, 14); i++) {
        const patternDay = pattern[i % pattern.length];
        const custody = patternDay === 1 ? 'you' : 'coparent';
        html += `<div class="mini-calendar-day ${custody}"></div>`;
      }

      return html;
    }

    // ============================================
    // CONFIGURE SCHEDULE
    // ============================================
    function renderConfigureOptions() {
      const container = $('#configureOptions');
      const pattern = CUSTODY_PATTERNS[state.schedule.type];

      if (!pattern) return;

      let html = '';

      if (pattern.fixedExchangeDays) {
        // Fixed schedules (2-2-3, 5-2-2-5, 3-4-4-3)
        html = `
          <div class="form-group">
            <label class="form-label">Who has the children on odd weeks?</label>
            <div class="chips" id="week1ParentChips">
              <div class="chip ${state.schedule.week1Parent === 'you' ? 'selected' : ''}" data-parent="you">You</div>
              <div class="chip ${state.schedule.week1Parent === 'coparent' ? 'selected' : ''}" data-parent="coparent">Co-parent</div>
            </div>
          </div>
        `;
      } else if (state.schedule.type === 'custom') {
        // Custom schedule builder
        html = `
          <div class="form-group">
            <label class="form-label">Build your custom pattern</label>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
              Click days to toggle between you (teal) and co-parent (gray).
            </p>
            <div id="customPatternBuilder"></div>
          </div>
        `;
      } else {
        // Rolling patterns (week-on-week-off, etc.)
        html = `
          <div class="form-group">
            <label class="form-label">Pick a date you know your schedule</label>
            <input type="date" class="form-input" id="anchorDateInput" value="${state.schedule.anchorDate}">
          </div>
          <div class="form-group">
            <label class="form-label">Who has the children on that date?</label>
            <div class="chips" id="anchorParentChips">
              <div class="chip ${state.schedule.anchorParent === 'you' ? 'selected' : ''}" data-parent="you">You</div>
              <div class="chip ${state.schedule.anchorParent === 'coparent' ? 'selected' : ''}" data-parent="coparent">Co-parent</div>
            </div>
          </div>
        `;
      }

      html += `
        <div class="form-group">
          <label class="form-label">Exchange time</label>
          <input type="time" class="form-input" id="exchangeTimeInput" value="${state.schedule.exchangeTime}">
        </div>
      `;

      container.innerHTML = html;

      // Event listeners
      if ($('#week1ParentChips')) {
        $$('#week1ParentChips .chip').forEach(chip => {
          chip.addEventListener('click', () => {
            $$('#week1ParentChips .chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.schedule.week1Parent = chip.dataset.parent;
            renderCalendar();
          });
        });
      }

      if ($('#anchorDateInput')) {
        $('#anchorDateInput').addEventListener('change', (e) => {
          state.schedule.anchorDate = e.target.value;
          renderCalendar();
        });
      }

      if ($('#anchorParentChips')) {
        $$('#anchorParentChips .chip').forEach(chip => {
          chip.addEventListener('click', () => {
            $$('#anchorParentChips .chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.schedule.anchorParent = chip.dataset.parent;
            renderCalendar();
          });
        });
      }

      if ($('#exchangeTimeInput')) {
        $('#exchangeTimeInput').addEventListener('change', (e) => {
          state.schedule.exchangeTime = e.target.value;
        });
      }

      if (state.schedule.type === 'custom') {
        renderCustomPatternBuilder();
      }
    }

    function renderCustomPatternBuilder() {
      const container = $('#customPatternBuilder');
      if (!container) return;

      // Initialize custom pattern if needed
      if (!state.schedule.customPattern) {
        state.schedule.customPattern = new Array(14).fill(1);
      }

      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">';

      // Labels
      html += days.map(d => `<div style="text-align: center; font-size: 12px; color: var(--text-muted); padding: 8px 0;">${d}</div>`).join('');

      // Week 1
      for (let i = 0; i < 7; i++) {
        const custody = state.schedule.customPattern[i] === 1 ? 'you' : 'coparent';
        html += `<div class="calendar-day ${custody}" data-day="${i}" style="cursor: pointer;"></div>`;
      }

      // Week 2
      for (let i = 7; i < 14; i++) {
        const custody = state.schedule.customPattern[i] === 1 ? 'you' : 'coparent';
        html += `<div class="calendar-day ${custody}" data-day="${i}" style="cursor: pointer;"></div>`;
      }

      html += '</div>';
      html += '<p style="font-size: 13px; color: var(--text-muted); text-align: center; margin-top: 12px;">This pattern repeats every 2 weeks</p>';

      container.innerHTML = html;

      container.querySelectorAll('.calendar-day').forEach(day => {
        day.addEventListener('click', () => {
          const dayIndex = parseInt(day.dataset.day);
          state.schedule.customPattern[dayIndex] = state.schedule.customPattern[dayIndex] === 1 ? 0 : 1;
          renderCustomPatternBuilder();
          renderCalendar();
        });
      });
    }

    // ============================================
    // CALENDAR
    // ============================================
    function renderCalendar() {
      const container = $('#calendarDays');
      const monthLabel = $('#calendarMonth');

      const year = calendarMonth.getFullYear();
      const month = calendarMonth.getMonth();

      monthLabel.textContent = calendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startPadding = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let html = '';

      // Padding for first week
      for (let i = 0; i < startPadding; i++) {
        html += '<div class="calendar-day empty"></div>';
      }

      // Days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const custody = getCustodyForDate(date);
        const isToday = date.getTime() === today.getTime();

        html += `<div class="calendar-day ${custody} ${isToday ? 'today' : ''}">${day}</div>`;
      }

      container.innerHTML = html;
    }

    function renderReviewCalendar() {
      const container = $('#reviewCalendarDays');
      const monthLabel = $('#reviewCalendarMonth');

      const year = reviewCalendarMonth.getFullYear();
      const month = reviewCalendarMonth.getMonth();

      monthLabel.textContent = reviewCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startPadding = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let html = '';

      for (let i = 0; i < startPadding; i++) {
        html += '<div class="calendar-day empty"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const custody = getCustodyForDate(date);
        const isToday = date.getTime() === today.getTime();

        html += `<div class="calendar-day ${custody} ${isToday ? 'today' : ''}">${day}</div>`;
      }

      container.innerHTML = html;
    }

    // ============================================
    // CUSTODY CALCULATION
    // ============================================
    function getCustodyForDate(date) {
      const pattern = CUSTODY_PATTERNS[state.schedule.type];
      if (!pattern) return 'you';

      if (state.schedule.type === 'custom' && state.schedule.customPattern) {
        return getCustomCustody(date);
      }

      if (pattern.fixedExchangeDays) {
        return getFixedScheduleCustody(date);
      }

      return getRollingScheduleCustody(date);
    }

    function getFixedScheduleCustody(date) {
      // ISO week-based calculation
      const isoWeek = getISOWeekNumber(date);
      const isOddWeek = isoWeek % 2 === 1;
      const isWeek1 = state.schedule.week1IsoParity === 'odd' ? isOddWeek : !isOddWeek;

      const pattern = CUSTODY_PATTERNS[state.schedule.type].pattern;
      const dayOfWeek = (date.getDay() + 6) % 7; // Convert to Mon=0

      const patternIndex = isWeek1 ? dayOfWeek : dayOfWeek + 7;
      const patternValue = pattern[patternIndex % pattern.length];

      const week1IsYou = state.schedule.week1Parent === 'you';
      return patternValue === 1 ? (week1IsYou ? 'you' : 'coparent') : (week1IsYou ? 'coparent' : 'you');
    }

    function getRollingScheduleCustody(date) {
      const pattern = CUSTODY_PATTERNS[state.schedule.type].pattern;
      const anchor = new Date(state.schedule.anchorDate + 'T00:00:00');
      const target = new Date(date);
      target.setHours(0, 0, 0, 0);

      const msPerDay = 24 * 60 * 60 * 1000;
      const daysDiff = Math.round((target - anchor) / msPerDay);
      const position = ((daysDiff % pattern.length) + pattern.length) % pattern.length;

      const patternValue = pattern[position];
      const anchorIsYou = state.schedule.anchorParent === 'you';

      return patternValue === 1 ? (anchorIsYou ? 'you' : 'coparent') : (anchorIsYou ? 'coparent' : 'you');
    }

    function getCustomCustody(date) {
      const anchor = new Date(state.schedule.anchorDate + 'T00:00:00');
      const target = new Date(date);
      target.setHours(0, 0, 0, 0);

      const msPerDay = 24 * 60 * 60 * 1000;
      const daysDiff = Math.round((target - anchor) / msPerDay);
      const position = ((daysDiff % 14) + 14) % 14;

      return state.schedule.customPattern[position] === 1 ? 'you' : 'coparent';
    }

    function getISOWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // ============================================
    // HOLIDAYS
    // ============================================
    function applyHolidayPreset() {
      const preset = state.holidayPreset;

      Object.values(HOLIDAYS).flat().forEach(holiday => {
        if (preset === 'alternate') {
          state.holidays[holiday.id] = 'alternate_you';
        } else if (preset === 'split') {
          // Alternate assignment based on index
          const allHolidays = Object.values(HOLIDAYS).flat();
          const index = allHolidays.findIndex(h => h.id === holiday.id);
          state.holidays[holiday.id] = index % 2 === 0 ? 'you' : 'coparent';
        }
        // custom - leave as is
      });
    }

    function renderHolidays() {
      const container = $('#holidayList');

      const sections = [
        { key: 'major', title: 'Major Holidays', holidays: HOLIDAYS.major },
        { key: 'spring_summer', title: 'Spring/Summer', holidays: HOLIDAYS.spring_summer, collapsible: true },
        { key: 'other', title: 'Other', holidays: HOLIDAYS.other, collapsible: true },
      ];

      container.innerHTML = sections.map(section => `
        <div class="holiday-section ${section.collapsible ? 'collapsed' : ''}" data-section="${section.key}">
          <div class="holiday-section-title">
            ${section.title}
            ${section.collapsible ? `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            ` : ''}
          </div>
          <div class="holiday-items">
            ${section.holidays.map(holiday => `
              <div class="holiday-item">
                <span class="holiday-name">${holiday.name}</span>
                <div class="holiday-chips" data-holiday="${holiday.id}">
                  <div class="holiday-chip ${state.holidays[holiday.id] === 'you' ? 'selected' : ''}" data-value="you">You</div>
                  <div class="holiday-chip ${state.holidays[holiday.id] === 'coparent' ? 'selected' : ''}" data-value="coparent">Co-parent</div>
                  <div class="holiday-chip ${(state.holidays[holiday.id] || '').startsWith('alternate') ? 'selected' : ''}" data-value="alternate_you">Alternate</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Section toggles
      $$('.holiday-section-title').forEach(title => {
        title.addEventListener('click', () => {
          const section = title.closest('.holiday-section');
          if (section.dataset.section !== 'major') {
            section.classList.toggle('collapsed');
          }
        });
      });

      // Holiday chip clicks
      $$('.holiday-chips').forEach(chips => {
        chips.querySelectorAll('.holiday-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            chips.querySelectorAll('.holiday-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.holidays[chips.dataset.holiday] = chip.dataset.value;

            // If user customizes, switch to custom preset
            $$('#holidayPresetChips .chip').forEach(c => c.classList.remove('selected'));
            $('#holidayPresetChips .chip[data-preset="custom"]').classList.add('selected');
            state.holidayPreset = 'custom';
          });
        });
      });
    }

    // ============================================
    // SUMMER
    // ============================================
    function renderSummerOptions() {
      const container = $('#summerOptions');
      container.style.display = state.summer.enabled ? 'block' : 'none';

      if (!state.summer.enabled) return;

      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const weeks = ['1st', '2nd', '3rd', '4th'];
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      container.innerHTML = `
        <div class="form-group">
          <label class="form-label">Summer starts</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <select class="form-input" id="summerStartWeek">
              ${weeks.map((w, i) => `<option value="${i + 1}" ${state.summer.startWeek === i + 1 ? 'selected' : ''}>${w}</option>`).join('')}
            </select>
            <select class="form-input" id="summerStartDay">
              ${days.map((d, i) => `<option value="${i}" ${state.summer.startWeekday === i ? 'selected' : ''}>${d}</option>`).join('')}
            </select>
            <select class="form-input" id="summerStartMonth">
              ${months.map((m, i) => `<option value="${i + 1}" ${state.summer.startMonth === i + 1 ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Summer ends</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <select class="form-input" id="summerEndWeek">
              ${weeks.map((w, i) => `<option value="${i + 1}" ${state.summer.endWeek === i + 1 ? 'selected' : ''}>${w}</option>`).join('')}
            </select>
            <select class="form-input" id="summerEndDay">
              ${days.map((d, i) => `<option value="${i}" ${state.summer.endWeekday === i ? 'selected' : ''}>${d}</option>`).join('')}
            </select>
            <select class="form-input" id="summerEndMonth">
              ${months.map((m, i) => `<option value="${i + 1}" ${state.summer.endMonth === i + 1 ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Summer schedule pattern</label>
          <div class="chips" id="summerPatternChips">
            <div class="chip ${state.summer.pattern === 'same-as-regular' ? 'selected' : ''}" data-pattern="same-as-regular">Same as regular</div>
            <div class="chip ${state.summer.pattern === 'alternating-weeks' ? 'selected' : ''}" data-pattern="alternating-weeks">Alternating weeks</div>
            <div class="chip ${state.summer.pattern === 'alternating-two-weeks' ? 'selected' : ''}" data-pattern="alternating-two-weeks">Alternating 2 weeks</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Who starts summer?</label>
          <div class="chips" id="summerStartsChips">
            <div class="chip ${state.summer.startsWithYou ? 'selected' : ''}" data-starts="you">You</div>
            <div class="chip ${!state.summer.startsWithYou ? 'selected' : ''}" data-starts="coparent">Co-parent</div>
          </div>
        </div>
      `;

      // Event listeners
      $('#summerStartWeek').addEventListener('change', (e) => { state.summer.startWeek = parseInt(e.target.value); });
      $('#summerStartDay').addEventListener('change', (e) => { state.summer.startWeekday = parseInt(e.target.value); });
      $('#summerStartMonth').addEventListener('change', (e) => { state.summer.startMonth = parseInt(e.target.value); });
      $('#summerEndWeek').addEventListener('change', (e) => { state.summer.endWeek = parseInt(e.target.value); });
      $('#summerEndDay').addEventListener('change', (e) => { state.summer.endWeekday = parseInt(e.target.value); });
      $('#summerEndMonth').addEventListener('change', (e) => { state.summer.endMonth = parseInt(e.target.value); });

      $$('#summerPatternChips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#summerPatternChips .chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          state.summer.pattern = chip.dataset.pattern;
        });
      });

      $$('#summerStartsChips .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#summerStartsChips .chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          state.summer.startsWithYou = chip.dataset.starts === 'you';
        });
      });
    }

    // ============================================
    // EXPENSES
    // ============================================
    function renderExpenseCategories() {
      const container = $('#categoryGrid');
      container.innerHTML = EXPENSE_CATEGORIES.map(cat => `
        <label class="category-checkbox ${state.expenses.categories.includes(cat.id) ? 'selected' : ''}" data-category="${cat.id}">
          <input type="checkbox" ${state.expenses.categories.includes(cat.id) ? 'checked' : ''}>
          <span class="checkbox-icon">${state.expenses.categories.includes(cat.id) ? '&#10003;' : ''}</span>
          <span class="category-label">${cat.name}</span>
        </label>
      `).join('');

      $$('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', () => {
          const cat = checkbox.dataset.category;
          const index = state.expenses.categories.indexOf(cat);
          if (index === -1) {
            state.expenses.categories.push(cat);
          } else {
            state.expenses.categories.splice(index, 1);
          }
          renderExpenseCategories();
          validateCurrentScreen();
        });
      });
    }

    function showCustomSplitInputs() {
      $('#customSplitInputs').innerHTML = `
        <div style="display: flex; gap: 16px; margin-bottom: 16px;">
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label class="form-label">You (%)</label>
            <input type="number" class="form-input" id="customSplitYou" min="0" max="100" value="${state.expenses.splitYou}">
          </div>
          <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label class="form-label">Co-parent (%)</label>
            <input type="number" class="form-input" id="customSplitCoparent" min="0" max="100" value="${state.expenses.splitCoparent}">
          </div>
        </div>
      `;
      $('#customSplitInputs').style.display = 'block';

      $('#customSplitYou').addEventListener('input', (e) => {
        const val = Math.min(100, Math.max(0, parseInt(e.target.value) || 0));
        state.expenses.splitYou = val;
        state.expenses.splitCoparent = 100 - val;
        $('#customSplitCoparent').value = state.expenses.splitCoparent;
        updateExpenseSplitDisplay();
      });

      $('#customSplitCoparent').addEventListener('input', (e) => {
        const val = Math.min(100, Math.max(0, parseInt(e.target.value) || 0));
        state.expenses.splitCoparent = val;
        state.expenses.splitYou = 100 - val;
        $('#customSplitYou').value = state.expenses.splitYou;
        updateExpenseSplitDisplay();
      });
    }

    function hideCustomSplitInputs() {
      $('#customSplitInputs').style.display = 'none';
    }

    function updateExpenseSplitDisplay() {
      $('#expenseFill').style.width = `${state.expenses.splitYou}%`;
      $('#expenseYou').textContent = `${state.expenses.splitYou}%`;
      $('#expenseCoparent').textContent = `${state.expenses.splitCoparent}%`;
    }

    // ============================================
    // REVIEW
    // ============================================
    function renderReview() {
      const container = $('#reviewSections');
      const pattern = CUSTODY_PATTERNS[state.schedule.type];

      const childrenNames = state.children
        .map(c => c.name || 'Child')
        .join(', ');

      const childrenAges = state.children
        .map(c => c.ageGroup.replace('-', ' to ').replace('under', 'Under'))
        .join(', ');

      const holidaySummary = Object.values(state.holidays).every(v => v === 'alternate_you')
        ? 'Alternating all holidays'
        : Object.values(state.holidays).filter(v => v === 'you').length + ' with you, ' +
          Object.values(state.holidays).filter(v => v === 'coparent').length + ' with co-parent';

      container.innerHTML = `
        <div class="review-section">
          <div class="review-section-header">
            <h3>Children</h3>
            <span class="edit-link" data-screen="1">Edit</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Names</span>
            <span class="review-item-value">${childrenNames}</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Ages</span>
            <span class="review-item-value">${childrenAges}</span>
          </div>
        </div>

        <div class="review-section">
          <div class="review-section-header">
            <h3>Regular Schedule</h3>
            <span class="edit-link" data-screen="2">Edit</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Pattern</span>
            <span class="review-item-value">${pattern?.name || 'Custom'}</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Split</span>
            <span class="review-item-value">${pattern?.split || 'Custom'}</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Exchange time</span>
            <span class="review-item-value">${formatTime(state.schedule.exchangeTime)}</span>
          </div>
        </div>

        <div class="review-section">
          <div class="review-section-header">
            <h3>Holidays</h3>
            <span class="edit-link" data-screen="4">Edit</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Arrangement</span>
            <span class="review-item-value">${holidaySummary}</span>
          </div>
        </div>

        ${state.summer.enabled ? `
          <div class="review-section">
            <div class="review-section-header">
              <h3>Summer</h3>
              <span class="edit-link" data-screen="5">Edit</span>
            </div>
            <div class="review-item">
              <span class="review-item-label">Pattern</span>
              <span class="review-item-value">${state.summer.pattern.replace(/-/g, ' ')}</span>
            </div>
            <div class="review-item">
              <span class="review-item-label">Starts with</span>
              <span class="review-item-value">${state.summer.startsWithYou ? 'You' : 'Co-parent'}</span>
            </div>
          </div>
        ` : ''}

        <div class="review-section">
          <div class="review-section-header">
            <h3>Expenses</h3>
            <span class="edit-link" data-screen="6">Edit</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Split</span>
            <span class="review-item-value">${state.expenses.splitYou}% / ${state.expenses.splitCoparent}%</span>
          </div>
          <div class="review-item">
            <span class="review-item-label">Categories</span>
            <span class="review-item-value">${state.expenses.categories.map(c => EXPENSE_CATEGORIES.find(ec => ec.id === c)?.name).join(', ')}</span>
          </div>
        </div>
      `;

      $$('.edit-link').forEach(link => {
        link.addEventListener('click', () => {
          const screenIndex = parseInt(link.dataset.screen);
          goToScreen(screenIndex);
        });
      });
    }

    function formatTime(time) {
      if (!time) return '6:00 PM';
      const [hours, minutes] = time.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    // ============================================
    // PRINT
    // ============================================
    function showPrintModal() {
      const pattern = CUSTODY_PATTERNS[state.schedule.type];
      const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      const childrenList = state.children
        .map(c => `${c.name || 'Child'} (age ${c.ageGroup.replace('-', '-')})`)
        .join(', ');

      let holidayText = '';
      Object.entries(state.holidays).forEach(([id, value]) => {
        const holiday = Object.values(HOLIDAYS).flat().find(h => h.id === id);
        if (holiday) {
          const assignment = value === 'you' ? 'You' : value === 'coparent' ? 'Co-parent' : 'Alternating';
          holidayText += `${holiday.name}: ${assignment}\n`;
        }
      });

      const content = `
        <h1>Custody Plan</h1>
        <p style="text-align: center; color: var(--text-muted);">Generated ${today}</p>

        <h2>Children</h2>
        <p>${childrenList}</p>

        <h2>Custody Schedule</h2>
        <p>The parties shall follow a <strong>${pattern?.name || 'custom'}</strong> schedule (${pattern?.split || 'custom split'}).</p>
        <p>Exchanges shall occur at <strong>${formatTime(state.schedule.exchangeTime)}</strong>.</p>

        <h2>Holiday Schedule</h2>
        <pre style="font-family: inherit; white-space: pre-wrap;">${holidayText}</pre>

        ${state.summer.enabled ? `
          <h2>Summer Schedule</h2>
          <p>The summer schedule shall be <strong>${state.summer.pattern.replace(/-/g, ' ')}</strong>, beginning with <strong>${state.summer.startsWithYou ? 'you' : 'co-parent'}</strong>.</p>
        ` : ''}

        <h2>Expense Allocation</h2>
        <p>Shared child-related expenses shall be divided <strong>${state.expenses.splitYou}% / ${state.expenses.splitCoparent}%</strong> (You / Co-parent).</p>
        <p>Categories: ${state.expenses.categories.map(c => EXPENSE_CATEGORIES.find(ec => ec.id === c)?.name).join(', ')}</p>

        <div class="print-footer">
          <p>Generated with Clearly | getclearly.app | This is a planning tool, not legal advice.</p>
        </div>
      `;

      $('#printContent').innerHTML = content;
      $('#printModal').classList.add('active');
    }

    function downloadPdf() {
      // Simple print-to-PDF approach
      window.print();
    }

    // ============================================
    // SUBMIT
    // ============================================
    async function submitPlan() {
      try {
        const planData = {
          email: state.email,
          first_name: state.firstName,
          children: state.children,
          custody_schedule: state.schedule.type,
          custody_anchor_date: state.schedule.anchorDate,
          custody_anchor_parent: state.schedule.anchorParent,
          week1_parent: state.schedule.week1Parent,
          week1_iso_parity: state.schedule.week1IsoParity,
          exchange_time: state.schedule.exchangeTime,
          custom_pattern: state.schedule.customPattern,
          holiday_preset: state.holidayPreset,
          holidays: state.holidays,
          summer_schedule_enabled: state.summer.enabled,
          summer_start_month: state.summer.startMonth,
          summer_start_week: state.summer.startWeek,
          summer_start_weekday: state.summer.startWeekday,
          summer_end_month: state.summer.endMonth,
          summer_end_week: state.summer.endWeek,
          summer_end_weekday: state.summer.endWeekday,
          summer_custody_pattern: state.summer.pattern,
          summer_starts_with: state.summer.startsWithYou ? 'you' : 'coparent',
          expense_split_you: state.expenses.splitYou,
          expense_split_coparent: state.expenses.splitCoparent,
          expense_categories: state.expenses.categories,
          reimbursement_method: state.expenses.reimbursementMethod,
          reimbursement_handle: state.expenses.reimbursementHandle,
          pathway: state.pathway,
          source: 'web-plan-builder',
        };

        const response = await fetch('https://dwncravjhkbclbuzijra.supabase.co/functions/v1/create-plan-template', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(planData),
        });

        const result = await response.json();

        if (response.ok && result.share_code) {
          state.planCode = result.share_code;
          $('#planCodeValue').textContent = result.share_code;
        } else {
          // Generate a local code as fallback
          state.planCode = generateLocalCode();
          $('#planCodeValue').textContent = state.planCode;
          console.error('Failed to save plan:', result);
        }
      } catch (error) {
        // Generate a local code as fallback
        state.planCode = generateLocalCode();
        $('#planCodeValue').textContent = state.planCode;
        console.error('Error submitting plan:', error);
      }
    }

    function generateLocalCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function copyPlanCode() {
      navigator.clipboard.writeText(state.planCode).then(() => {
        const btn = $('#copyCodeBtn');
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = 'Copy Code';
        }, 2000);
      });
    }

    // ============================================
    // FILE UPLOAD
    // ============================================
    function handleFileUpload(e) {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    }

    async function handleFile(file) {
      if (file.type !== 'application/pdf') {
        alert('Please upload a PDF file.');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be under 10MB.');
        return;
      }

      $('#uploadZone').style.display = 'none';
      $('#uploadLoading').style.display = 'block';

      try {
        // Convert file to base64
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        $('#uploadStatus').textContent = 'Analyzing your agreement...';

        const response = await fetch('https://dwncravjhkbclbuzijra.supabase.co/functions/v1/parse-agreement', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ document: base64 }),
        });

        const result = await response.json();
        console.log('Parse result:', result);

        if (response.ok && result.data) {
          // Apply parsed data to state
          if (result.data.schedule) {
            state.schedule.type = result.data.schedule.type || state.schedule.type;
          }
          if (result.data.holidays) {
            state.holidays = { ...state.holidays, ...result.data.holidays };
          }
          // Continue to next screen
          goNext();
        } else {
          console.error('Parse error:', result);
          const errorMsg = result.details || result.error || 'Unknown error';
          alert('Could not parse agreement: ' + errorMsg + '\n\nPlease enter manually.');
          $('#uploadZone').style.display = 'block';
          $('#uploadLoading').style.display = 'none';
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert('Error processing file. Please try again or enter manually.');
        $('#uploadZone').style.display = 'block';
        $('#uploadLoading').style.display = 'none';
      }
    }

    // Initialize
    init();
  </script>
</body>
</html>
